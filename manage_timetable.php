<?php
session_start();
if (!isset($_SESSION['user']) || $_SESSION['user']['role'] !== 'admin') {
    header("Location: login.php");
    exit();
}
$user = $_SESSION['user'];

$host = 'localhost';
$db = 'classroom_booking';
$username = 'root';
$password = 'root';

$conn = new mysqli($host, $username, $password, $db);
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

$rooms = $conn->query("SELECT * FROM rooms");

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
$search = isset($_GET['search']) ? $_GET['search'] : '';

// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô
$sql = "SELECT t.*, r.room_name FROM timetable t 
        JOIN rooms r ON t.room_id = r.id 
        WHERE 
            t.subject_name LIKE '%$search%' OR 
            r.room_name LIKE '%$search%' OR 
            t.teacher_name LIKE '%$search%' OR 
            t.day_of_week LIKE '%$search%' OR 
            t.semester LIKE '%$search%' OR 
            t.academic_year LIKE '%$search%'
        ORDER BY day_of_week, period";
$timetables = $conn->query($sql);
?>

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô | ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            display: flex;
            min-height: 100vh;
            margin: 0;
        }
        .sidebar {
            width: 250px;
            background-color: #007bff;
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100%;
        }
        .sidebar a {
            color: white;
            display: block;
            margin: 1rem 0;
            text-decoration: none;
        }
        .sidebar a:hover {
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            padding-left: 10px;
        }
        .content {
            margin-left: 250px;
            padding: 2rem;
            flex-grow: 1;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>

<div class="sidebar">
    <h4 class="text-white">üìò ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</h4>
    <a href="home.php"><i class="bi bi-house-door-fill"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
    <a href="rooms.php"><i class="bi bi-door-open-fill"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á</a>
    <a href="booking.php"><i class="bi bi-calendar-check-fill"></i> ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</a>
    <a href="booking_list.php"><i class="bi bi-journal-text"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</a>
    <a href="users.php"><i class="bi bi-people-fill"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</a>
    <a href="manage_rooms.php"><i class="bi bi-building"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á</a>
    <a href="manage_timetable.php"><i class="bi bi-table"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô</a>
    <a href="manage_booking.php"><i class="bi bi-clipboard-data-fill"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</a>
    
    <a href="user_guide.php"><i class="bi bi-question-circle-fill"></i> ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a>
    <hr>
    <a href="logout.php"><i class="bi bi-box-arrow-right"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
</div>

<div class="content">
    <h2><i class="bi bi-table"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô</h2>
    <p class="mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á</p>

    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</h5>
        </div>
        <div class="card-body">
            <form action="add_timetable.php" method="POST">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</label>
                        <select name="room_id" class="form-select" required>
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>
                            <?php while ($room = $rooms->fetch_assoc()): ?>
                                <option value="<?= $room['id'] ?>"><?= $room['room_name'] ?></option>
                            <?php endwhile; ?>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</label>
                        <input type="text" name="subject_name" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</label>
                        <input type="text" name="teacher_name" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">‡∏ß‡∏±‡∏ô</label>
                        <select name="day_of_week" class="form-select" required>
                            <option value="‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option>
                            <option value="‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option>
                            <option value="‡∏û‡∏∏‡∏ò">‡∏û‡∏∏‡∏ò</option>
                            <option value="‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ">‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</option>
                            <option value="‡∏®‡∏∏‡∏Å‡∏£‡πå">‡∏®‡∏∏‡∏Å‡∏£‡πå</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <input type="number" name="period" class="form-control" placeholder="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                        <input type="time" name="start_time" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                        <input type="time" name="end_time" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <input type="text" name="semester" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                        <input type="text" name="academic_year" class="form-control" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary mt-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô</button>
            </form>
        </div>
    </div>

    <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
    <form method="GET" class="mb-3">
        <div class="input-group">
            <input type="text" name="search" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤ / ‡∏´‡πâ‡∏≠‡∏á..." value="<?= htmlspecialchars($search) ?>">
            <button class="btn btn-outline-primary" type="submit"><i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        </div>
    </form>

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô -->
    <h4>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>‡∏´‡πâ‡∏≠‡∏á</th>
                <th>‡∏ß‡∏¥‡∏ä‡∏≤</th>
                <th>‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</th>
                <th>‡∏ß‡∏±‡∏ô</th>
                <th>‡∏Ñ‡∏≤‡∏ö</th>
                <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
                <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th>
                <th>‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                <th>‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
                <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
        </thead>
        <tbody>
            <?php while ($row = $timetables->fetch_assoc()): ?>
                <tr>
                    <td><?= htmlspecialchars($row['room_name']) ?></td>
                    <td><?= htmlspecialchars($row['subject_name']) ?></td>
                    <td><?= htmlspecialchars($row['teacher_name']) ?></td>
                    <td><?= htmlspecialchars($row['day_of_week']) ?></td>
                    <td><?= htmlspecialchars($row['period']) ?></td>
                    <td><?= htmlspecialchars($row['start_time']) ?></td>
                    <td><?= htmlspecialchars($row['end_time']) ?></td>
                    <td><?= htmlspecialchars($row['semester']) ?></td>
                    <td><?= htmlspecialchars($row['academic_year']) ?></td>
                    <td>
                        <a href="edit_timetable.php?id=<?= $row['id'] ?>" class="btn btn-warning btn-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</a>
                        <a href="delete_timetable.php?id=<?= $row['id'] ?>" class="btn btn-danger btn-sm" onclick="return confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏ô‡∏µ‡πâ?')">‡∏•‡∏ö</a>
                    </td>
                </tr>
            <?php endwhile; ?>
        </tbody>
    </table>
</div>
</body>
</html>

<?php $conn->close(); ?>